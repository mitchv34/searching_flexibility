# CPS Wage Non-Response Reweighting

## 1. Overview
When restricting to respondents with valid wage information, **item non-response** can bias estimates if the probability of reporting wages is correlated with outcomes of interest. Let the original CPS person weight be $w_i = \text{WTFINL}_i$. We construct adjusted weights $w_i^{*}$ for the wage-reporting subsample so that its weighted distribution over selected demographic variables matches that of the broader target universe before the wage requirement is imposed.

## 2. Samples
Define two nested samples:
1. **Universe (target) sample** $U$: records passing structural filters (employment class, hours, plausible demographics) with non-missing $w_i$.
2. **Wage sample** $S \subset U$: subset with valid wage information (non-missing, $\text{WAGE}_i \ge 0$).

Goal: For each post-stratification cell $g$, match
$$
\sum_{i \in S \cap g} w_i^{*} = \sum_{i \in U \cap g} w_i =: T_g.
$$

## 3. Post-Stratification Cells
Default stratification variables:
$$
g = (\text{YEAR}, \text{SEX}, \text{EDUC}, \text{RACE}, \text{AGE\_GROUP}).
$$
Age is bucketed: 18–24, 25–34, 35–44, 45–54, 55–64, 65+.

For each cell $g$ define:
$$
T_g = \sum_{i \in U \cap g} w_i, \qquad O_g = \sum_{i \in S \cap g} w_i.
$$
The raw adjustment factor:
$$
A_g^{\text{raw}} = \begin{cases}
1 & O_g \le 0 \\
T_g / O_g & O_g > 0
\end{cases}
$$
We optionally cap: $A_g = \min(A_g^{\text{raw}}, c)$ with cap $c=5$ (tunable) to reduce variance inflation.

Each responding unit $i \in S \cap g$ receives provisional adjusted weight:
$$
	ilde{w}_i = w_i A_g.
$$

### Year Calibration
To preserve annual control totals we scale within each year $y$:
$$
K_y = \frac{ \sum_{i \in U, YEAR_i = y} w_i }{ \sum_{i \in S, YEAR_i = y} \tilde{w}_i }, \qquad w_i^{*} = \tilde{w}_i K_{YEAR_i}.
$$
Thus for every $y$: $\sum_{i \in S, YEAR_i=y} w_i^{*} = \sum_{i \in U, YEAR_i=y} w_i.$

## 4. Final Weight Definitions
Universe file keeps original $w_i$. Wage file contains:
- `WTFINL` = $w_i^{*}$ (the adjusted weight)
- `WTFINL_ORIG` = original $w_i$ (facilitates sensitivity analysis)

## 5. Diagnostics & Weight Quality
We log: counts, number of capped cells, total weight difference, and run time. A useful additional diagnostic (not yet output) is the **effective sample size**:
$$
n_{\text{eff}} = \frac{\left(\sum_i w_i^{*}\right)^2}{\sum_i (w_i^{*})^2},
$$
which declines as weight dispersion increases (design effect $= n / n_{\text{eff}}$). High dispersion may suggest tighter capping or coarser cells.

## 6. Why These Refinements?
| Issue | Mitigation |
|-------|------------|
| Sparse cells inflate factors | Age grouping + capping $A_g$ |
| Year-to-year shifts | Year calibration $K_y$ |
| Hidden variance inflation | Optional monitoring via $n_{eff}$ |
| Transparency | Retain original weight as `WTFINL_ORIG` |

## 7. Raking / IPF (Iterative Proportional Fitting) Alternative
**Raking** (also called **Iterative Proportional Fitting, IPF**) adjusts weights to simultaneously match *marginal* (not full cross) control totals for several dimensions. Suppose we want margins for variables $X^{(1)}, X^{(2)}, \ldots, X^{(K)}$ with category sets $C_k$ and target totals $T_{k,c}$ (derived here from the universe sample). Start with initial weights $w_i^{(0)} = w_i$ for $i \in S$. For iteration $t=1,2,\dots$, and for each dimension $k=1,\dots,K$:
$$
f_{k,c}^{(t)} = \frac{T_{k,c}}{\sum_{i \in S: X_i^{(k)} = c} w_i^{(t-1)}}, \qquad
w_i^{(t)} = w_i^{(t-1)} f_{k, X_i^{(k)}}^{(t)}.
$$
Cycle through all $k$ until convergence (e.g. maximum relative deviation of achieved vs. target margins < $\varepsilon$). Optionally trim weights after each full cycle to control extremes. Raking is advantageous when the full Cartesian product of stratifiers would produce many sparse cells; it enforces marginal rather than joint alignment. In our context, if adding geography (e.g. `CENSUSDIV`) and occupation (`OCCSOC_MINOR`) makes cross-cells too thin, raking offers a stable alternative.

### When to Prefer Raking/IPF
- Many stratifiers with moderate category counts (full cross too large).
- Need to incorporate additional controls without exploding cell count.
- Desire to match published marginal benchmarks (e.g., BLS region distributions).

### When Post-Stratification is Fine
- Crossed cells are sufficiently populated (avoid small $O_g$).
- Joint distribution is substantively important (interactions matter).

## 8. Practical Guidance
Use post-stratification first (simpler, deterministic for a given cell set). If weight dispersion is high or you must add more dimensions, consider migrating to raking/IPF using the universe-derived marginal totals as targets. Always inspect the distribution of $w_i^{*}$ (e.g., percentiles, max/min, coefficient of variation) and, if possible, compute $n_{\text{eff}}$.

## 9. Outputs
Generated by the pipeline:
- `*_universe.csv` — universe sample with original `WTFINL`.
- `*_wage_reweighted.csv` — wage-reporting sample with adjusted `WTFINL` and original `WTFINL_ORIG`.

## 10. Configuration (Code Reference)
Implementation: `reweight_for_wage_nonresponse` in `src/empirical/cps_data_prep/wfh_cps_polar.py`.
- `cell_vars`: list of joint stratifiers (default above; must contain `YEAR`).
- `cap_factor = c`: set `None` to disable capping.
- `min_wage`: lower wage bound (default 0).

## 11. Extension Ideas
- Implement full IPF/raking option with convergence diagnostics.
- Export adjustment factors and weight distribution summary tables.
- Add automated trimming (e.g., winsorize top 0.1%).
- Compute and store $n_{eff}$ and design effect.

## 12. Recommended Use
- Use universe file + `WTFINL` for analyses not conditioning on reported wages.
- Use wage file + adjusted `WTFINL` for wage-conditioned analyses.
- Conduct robustness: vary cap (3, 5, 10, None); expand/reduce cell set.

---
Questions for future refinement: Do occupation or geography materially affect non-response? If yes, add them via raking to avoid sparsity while controlling their margins.
